<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Student Fee Tracker</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; }
  h2 { text-align: center; font-size: 18px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 2px 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  th:first-child, td:first-child { width: 30px; }
  th:nth-child(2), td:nth-child(2) { width: 140px; text-align: left; }
  th:nth-child(3), td:nth-child(3) { width: 50px; }
  th:nth-child(4), td:nth-child(4) { width: 60px; } /* a bit tighter */
  th:nth-child(5), td:nth-child(5) { width: 60px; } /* a bit tighter */
  th:nth-child(6), td:nth-child(6) { width: 90px; }
  th:nth-child(7), td:nth-child(7) { width: 70px; } /* fits 4 digits nicely */
  th:nth-child(8), td:nth-child(8) { width: 95px; }
  th:nth-child(9), td:nth-child(9) { width: 50px; }
  th { background: #f2f2f2; font-size: 13px; }
  input, select, button { font-size: 12px; padding: 2px 3px; }
  input[type="number"] { text-align: right; }
  .controls { margin: 8px 0; display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; font-size: 12px; }
  .totals { margin-top: 10px; display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; }
  .paid { color: green; }
  .unpaid { color: red; }
  .delBtn { background: red; color: white; border: none; padding: 2px 6px; cursor: pointer; border-radius: 4px; font-size: 12px; }

  /* Visual cue on Fee Paid select */
  .paidSelect.yes { background: #e8f5e9; color: #1b5e20; }
  .paidSelect.no  { background: #ffebee; color: #b71c1c; }

  @media (max-width: 600px) {
    table, thead, tbody, th, td, tr { display: block; }
    thead tr { display: none; }
    tr { margin-bottom: 10px; border-bottom: 2px solid #ccc; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td::before { content: attr(data-label); position: absolute; left: 5px; width: 45%; text-align: left; font-weight: bold; }
  }
</style>
</head>
<body>
<h2>üìò Student Fee Tracker</h2>

<div class="controls">
  <label for="monthSelect">Select Month:</label>
  <select id="monthSelect"></select>
  <button onclick="saveData()">üíæ Save</button>
  <button onclick="newMonth()">‚ûï New Month</button>
  <button onclick="clearMonth()">üóëÔ∏è Clear Month</button>
  <button onclick="exportCSV()">üì• Export CSV</button>
  <span id="currentMonthDisplay" style="margin-left:10px;font-weight:bold;"></span>
</div>

<table id="feeTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Student's Name</th>
      <th>Class</th>
      <th>Advance Fee</th>
      <th>Fee Paid</th>
      <th>Joining Date</th>
      <th>Fixed Fee</th>
      <th>Payment Date</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>
<button onclick="addRow()">‚ûï Add Student</button>

<div class="totals">
  <div class="unpaid">Unpaid Total: <span id="unpaidTotal">0</span></div>
  <div class="paid">Paid Total: <span id="paidTotal">0</span></div>
</div>

<script>
/* ---------- Helpers ---------- */
const monthSelect = document.getElementById("monthSelect");
const tableBody = document.getElementById("tableBody");
const currentMonthDisplay = document.getElementById("currentMonthDisplay");
let currentMonth = getCurrentMonth();

/* Local-date YYYY-MM-DD (avoids UTC shift problems) */
function todayLocalISO() {
  const d = new Date();
  const tzOff = d.getTimezoneOffset();
  const local = new Date(d.getTime() - tzOff * 60000);
  return local.toISOString().split("T")[0];
}

function getCurrentMonth() {
  const today = new Date();
  return today.toLocaleString("default", { month: "long", year: "numeric" });
}

/* ---------- Months ---------- */
function populateMonths() {
  monthSelect.innerHTML = "";
  let months = JSON.parse(localStorage.getItem("monthList") || "[]");

  if (!months.includes(currentMonth)) {
    months.push(currentMonth);
    localStorage.setItem("monthList", JSON.stringify(months));
  }

  months.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    monthSelect.appendChild(opt);
  });

  monthSelect.value = currentMonth;
  updateMonthDisplay();
}

function updateMonthDisplay() {
  currentMonthDisplay.textContent = currentMonth;
}

function saveMonthList(newMonth) {
  let months = JSON.parse(localStorage.getItem("monthList") || "[]");
  if (!months.includes(newMonth)) {
    months.push(newMonth);
    localStorage.setItem("monthList", JSON.stringify(months));
  }
}

/* ---------- Rows ---------- */
function addRow(data = {}) {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td data-label="#"> </td>
    <td data-label="Student's Name"><input type="text" value="${data.name || ''}" placeholder="Full name"></td>
    <td data-label="Class"><input type="text" value="${data.class || ''}" placeholder="e.g., 8th"></td>
    <td data-label="Advance Fee">
      <select>
        <option ${data.advance === "No" ? "selected" : ""}>No</option>
        <option ${data.advance === "Yes" ? "selected" : ""}>Yes</option>
      </select>
    </td>
    <td data-label="Fee Paid">
      <select class="paidSelect" onchange="handleFeePaidChange(this)">
        <option ${data.paid === "No" ? "selected" : ""}>No</option>
        <option ${data.paid === "Yes" ? "selected" : ""}>Yes</option>
      </select>
    </td>
    <td data-label="Joining Date"><input type="date" value="${data.joinDate || ''}"></td>
    <td data-label="Fixed Fee"><input type="number" inputmode="numeric" min="0" value="${data.fixedFee || ''}" oninput="updateTotals()"></td>
    <td data-label="Payment Date"><input type="date" value="${data.paymentDate || ''}" readonly></td>
    <td data-label="Action"><button class="delBtn" onclick="deleteRow(this)">‚ùå</button></td>
  `;
  tableBody.appendChild(row);
  updateSerialNumbers();
  refreshPaidSelectStyle(row);
  updateTotals();
  highlightTodayPayments();
}

function updateSerialNumbers() {
  tableBody.querySelectorAll("tr").forEach((r, i) => r.children[0].textContent = i + 1);
}

/* ---------- Interactions ---------- */
function handleFeePaidChange(select) {
  const row = select.closest("tr");
  const paymentCell = row.querySelectorAll("input[type=date]")[1];
  if (select.value === "Yes") {
    paymentCell.value = todayLocalISO(); // local date (fixes UTC issue)
  } else {
    paymentCell.value = "";
  }
  refreshPaidSelectStyle(row);
  updateTotals();
  highlightTodayPayments();
}

function refreshPaidSelectStyle(row) {
  const sel = row.querySelector(".paidSelect");
  sel.classList.remove("yes", "no");
  sel.classList.add(sel.value === "Yes" ? "yes" : "no");
}

function deleteRow(btn) {
  btn.closest("tr").remove();
  updateSerialNumbers();
  updateTotals();
}

/* ---------- Save / Load ---------- */
function saveData() {
  const rows = tableBody.querySelectorAll("tr");
  const data = [];
  rows.forEach(r => {
    const inputs = r.querySelectorAll("input, select");
    data.push({
      name: inputs[0].value,
      class: inputs[1].value,
      advance: inputs[2].value,
      paid: inputs[3].value,
      joinDate: inputs[4].value,
      fixedFee: inputs[5].value,
      paymentDate: inputs[6].value
    });
  });
  localStorage.setItem("studentFee_" + currentMonth, JSON.stringify(data));
  populateMonths();
  updateTotals();
  alert("Data saved for " + currentMonth);
}

function loadData(month) {
  tableBody.innerHTML = "";
  currentMonth = month;
  updateMonthDisplay();
  const saved = JSON.parse(localStorage.getItem("studentFee_" + month) || "[]");
  if (saved.length) saved.forEach(s => addRow(s));
  else addRow();
}

/* ---------- Months actions ---------- */
function newMonth() {
  const newMonthName = prompt("Enter new month name (e.g., August 2025):", "");
  if (!newMonthName) return;

  saveData(); // save current month first
  const lastMonthData = JSON.parse(localStorage.getItem("studentFee_" + currentMonth) || "[]");

  currentMonth = newMonthName;
  saveMonthList(currentMonth);

  tableBody.innerHTML = "";

  if (lastMonthData.length) {
    lastMonthData.forEach(student => addRow({
      name: student.name,
      class: student.class,
      joinDate: student.joinDate,
      fixedFee: student.fixedFee,
      advance: student.advance,
      paid: "No",
      paymentDate: ""
    }));
  } else {
    addRow();
  }

  populateMonths();
  updateMonthDisplay();
}

function clearMonth() {
  if (confirm("Delete all data for " + currentMonth + "?")) {
    localStorage.removeItem("studentFee_" + currentMonth);
    loadData(currentMonth); // keep month but clear rows
  }
}

/* ---------- Export ---------- */
function exportCSV() {
  const rows = tableBody.querySelectorAll("tr");
  if (!rows.length) { alert("No data!"); return; }

  const esc = v => `"${String(v).replace(/"/g, '""')}"`;
  let csv = '#,"Student\'s Name",Class,"Advance Fee","Fee Paid","Joining Date","Fixed Fee","Payment Date"\n';

  rows.forEach((r, i) => {
    const inputs = r.querySelectorAll("input, select");
    const line = [
      i + 1,
      esc(inputs[0].value),
      esc(inputs[1].value),
      esc(inputs[2].value),
      esc(inputs[3].value),
      esc(inputs[4].value),
      esc(inputs[5].value),
      esc(inputs[6].value)
    ].join(",");
    csv += line + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = currentMonth + ".csv";
  link.click();
}

/* ---------- Totals & Highlights ---------- */
function updateTotals() {
  let paid = 0, unpaid = 0;
  tableBody.querySelectorAll("tr").forEach(r => {
    const feeVal = r.querySelector('input[type="number"]')?.value ?? "";
    const fee = Number(feeVal);
    const paidStatus = r.querySelectorAll("select")[1]?.value;
    if (!Number.isNaN(fee)) {
      if (paidStatus === "Yes") paid += fee;
      else unpaid += fee;
    }
  });
  document.getElementById("paidTotal").textContent = paid;
  document.getElementById("unpaidTotal").textContent = unpaid;
}

function highlightTodayPayments() {
  const today = todayLocalISO(); // local date
  tableBody.querySelectorAll("tr").forEach(r => {
    const cell = r.querySelectorAll('input[type="date"]')[1];
    cell.style.backgroundColor = (cell.value === today) ? "#fff3b0" : "";
  });
}

/* ---------- Init ---------- */
monthSelect.addEventListener("change", () => loadData(monthSelect.value));
populateMonths();
loadData(currentMonth);
</script>
</body>
</html>
